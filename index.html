<script>
        // --- CONFIGURACIÓN ---
        // ¡¡¡IMPORTANTE!!! PEGA AQUÍ LA URL DE TU APLICACIÓN WEB DE GOOGLE
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzMYNMybUueXMqUTwQoVfw887laT98aAv-qzstQwHBjF1JhfoQtIxvg2HhVvtxNSH1T/exec';

        // --- VARIABLES Y ELEMENTOS (sin cambios) ---
        let loggedInUser = null;
        const MAX_ADDITIONAL_PHOTOS = 10;
        const loginSection = document.getElementById('login-section');
        const pedidoSection = document.getElementById('pedido-section');
        const loginForm = document.getElementById('login-form');
        const pedidoForm = document.getElementById('pedido-form');
        const statusDiv = document.getElementById('status');
        const loader = document.getElementById('loader');
        const origenSelect = document.getElementById('origen');
        const nvFields = document.getElementById('nv-fields');
        const nvRelatedFields = document.getElementById('nv-related-fields');
        const tipoDespachoSelect = document.getElementById('tipoDespacho');
        const courierField = document.getElementById('courier-field');
        const additionalPhotosInput = document.getElementById('additionalPhotosInfo');
        const photosPreview = document.getElementById('photos-preview');

        // --- MANEJADORES DE EVENTOS (ligeramente modificados) ---
        loginForm.addEventListener('submit', handleLoginSubmit);
        pedidoForm.addEventListener('submit', handlePedidoSubmit);
        
        // ... (el resto de manejadores de eventos para la UI no cambian) ...
        origenSelect.addEventListener('change', function() {
            const isNV = this.value === 'NV';
            nvFields.classList.toggle('hidden', !isNV);
            nvRelatedFields.classList.toggle('hidden', !isNV);
            document.getElementById('vendedor').required = isNV;
            document.getElementById('relatedNvNumber').required = isNV;
        });
        tipoDespachoSelect.addEventListener('change', function() {
            const isEnvio = this.value === 'Envío a Domicilio';
            courierField.classList.toggle('hidden', !isEnvio);
            document.getElementById('courier').required = isEnvio;
        });
        additionalPhotosInput.addEventListener('change', function(event) {
            photosPreview.innerHTML = '';
            const files = Array.from(event.target.files).slice(0, MAX_ADDITIONAL_PHOTOS);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.classList.add('preview-image');
                    photosPreview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });

        // --- FUNCIONES DE LÓGICA (MODIFICADAS PARA USAR fetch) ---
        
        async function handleLoginSubmit(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (!username || !password) {
                showStatus('Por favor, ingrese usuario y contraseña.', 'error');
                return;
            }
            toggleLoader(true);

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Necesario para evitar preflight CORS
                    body: JSON.stringify({
                        action: 'checkLogin',
                        data: { username, password }
                    })
                });
                const result = await response.json();

                if (result.success) {
                    onLoginSuccess();
                } else {
                    onFailure({ message: result.error || 'Usuario o contraseña inválido.' });
                }
            } catch (error) {
                onFailure(error);
            } finally {
                toggleLoader(false);
            }
        }

        async function handlePedidoSubmit(e) {
            e.preventDefault();
            if (!pedidoForm.checkValidity()) {
                pedidoForm.reportValidity();
                showStatus('Por favor, complete todos los campos obligatorios.', 'error');
                return;
            }
            toggleLoader(true);
            showStatus('Procesando...', 'info');

            try {
                // La lógica para leer archivos no cambia
                const docFile = document.getElementById('nvDocumentInfo').files[0];
                const additionalFiles = Array.from(document.getElementById('additionalPhotosInfo').files).slice(0, MAX_ADDITIONAL_PHOTOS);
                const nvDocumentInfoPromise = readFileAsBase64(docFile);
                const additionalPhotosInfoPromises = additionalFiles.map(file => readFileAsBase64(file));
                const [nvDocumentInfo, ...additionalPhotosInfo] = await Promise.all([nvDocumentInfoPromise, ...additionalPhotosInfoPromises]);

                const formData = { /* ... (el objeto formData se construye igual que antes) ... */
                    origen: document.getElementById('origen').value,
                    identifier: document.getElementById('identifier').value,
                    user: loggedInUser,
                    description: document.getElementById('description').value,
                    vendedor: document.getElementById('vendedor').value,
                    relatedNvNumber: document.getElementById('relatedNvNumber').value,
                    armadoPor: document.getElementById('armadoPor').value,
                    fechaPedido: document.getElementById('fechaPedido').value,
                    nombreCliente: document.getElementById('nombreCliente').value,
                    tipoDespacho: document.getElementById('tipoDespacho').value,
                    courier: document.getElementById('courier').value,
                    numeroBultos: document.getElementById('numeroBultos').value,
                    nvDocumentInfo: nvDocumentInfo,
                    additionalPhotosInfo: additionalPhotosInfo
                };
                
                // La nueva llamada usando fetch
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'processFormData',
                        data: formData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    onFormSuccess(result.message);
                } else {
                    onFailure({ message: result.error });
                }

            } catch (error) {
                onFailure(error);
            } finally {
                toggleLoader(false);
            }
        }

        // --- FUNCIONES DE UTILIDAD (Callbacks y Helpers - modificados para ser más genéricos) ---

        function onLoginSuccess() {
            loggedInUser = document.getElementById('username').value.trim();
            loginSection.classList.add('hidden');
            pedidoSection.classList.remove('hidden');
            document.getElementById('welcome-user').textContent = `| Usuario: ${loggedInUser}`;
            showStatus('');
            document.getElementById('fechaPedido').valueAsDate = new Date();
        }
        
        function onFormSuccess(message) {
            showStatus(message, 'success');
            pedidoForm.reset();
            photosPreview.innerHTML = '';
            document.getElementById('fechaPedido').valueAsDate = new Date();
            nvFields.classList.add('hidden');
            nvRelatedFields.classList.add('hidden');
            courierField.classList.add('hidden');
        }

        function onFailure(error) {
            showStatus(`Error: ${error.message}`, 'error');
        }

        function showStatus(message, type = '') {
            statusDiv.textContent = message;
            statusDiv.className = type ? `status-${type}` : '';
        }

        function toggleLoader(show) {
            loader.classList.toggle('hidden', !show);
            document.getElementById('submit-btn').disabled = show;
        }

        // La función readFileAsBase64 no cambia
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve(null);
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64Data = e.target.result.split(',')[1];
                    resolve({
                        base64Data: base64Data,
                        mimeType: file.type,
                        fileName: file.name
                    });
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>
